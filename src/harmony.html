<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Licensed under the MIT license: -->
<!-- http://www.opensource.org/licenses/mit-license.php -->
<!-- Copyright (c) 2010 Mr.doob, rhyolight, bebraw -->
<html lang="en">
    <head>
        <title>Harmony</title>
        
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">

        <link rel="stylesheet" type="text/css" href="css/ui-darkness/jquery-ui-1.8.custom.css" />
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <link rel="stylesheet" type="text/css" href="css/colorpicker.css">

        <script type="text/javascript" src="js/lib/jquery.js"></script>
        <script type="text/javascript" src="js/lib/jquery-ui.js"></script>
        <script type="text/javascript" src="js/lib/jquery-keycodes.js"></script>
        <script type="text/javascript" src="js/lib/jquery-drag.js"></script>
        <script type="text/javascript" src="js/lib/shortcut.js"></script>
        <script type="text/javascript" src="js/lib/base64.js"></script>
        <script type="text/javascript" src="js/lib/splitter.js"></script>
        <script type="text/javascript" src="js/lib/canvas2image.js"></script>
        <script type="text/javascript" src="js/lib/jscolor/jscolor.js"></script>

        <script type="text/javascript" src="js/panels/brushes.js"></script>
        <script type="text/javascript" src="js/panels/canvas.js"></script>
        <script type="text/javascript" src="js/panels/modifiers.js"></script>
        <script type="text/javascript" src="js/panels/playback.js"></script>
        <script type="text/javascript" src="js/panels/palette.js"></script>

        <script type="text/javascript" src="js/brushes/sketchy.js"></script>
        <script type="text/javascript" src="js/brushes/shaded.js"></script>
        <script type="text/javascript" src="js/brushes/chrome.js"></script>
        <script type="text/javascript" src="js/brushes/fur.js"></script>
        <script type="text/javascript" src="js/brushes/longfur.js"></script>
        <script type="text/javascript" src="js/brushes/web.js"></script>
        <script type="text/javascript" src="js/brushes/simple.js"></script>
        <script type="text/javascript" src="js/brushes/square.js"></script>
        <script type="text/javascript" src="js/brushes/ribbon.js"></script>
        <script type="text/javascript" src="js/brushes/circles.js"></script>
        <script type="text/javascript" src="js/brushes/squares.js"></script>
        <script type="text/javascript" src="js/brushes/grid.js"></script>
        <script type="text/javascript" src="js/brushes/stringy.js"></script>
        <script type="text/javascript" src="js/brushes/curvy.js"></script>
        <script type="text/javascript" src="js/brushes/eraser.js"></script>
        <script type="text/javascript" src="js/brushes/blur.js"></script>

        <script type="text/javascript" src="js/constraints/horizontal.js"></script>
        <script type="text/javascript" src="js/constraints/perspective.js"></script>
        <script type="text/javascript" src="js/constraints/vertical.js"></script>

        <script type="text/javascript" src="js/modifiers/array.js"></script>
        <script type="text/javascript" src="js/modifiers/group.js"></script>
        <script type="text/javascript" src="js/modifiers/horizontalmirror.js"></script>
        <script type="text/javascript" src="js/modifiers/radialmirror.js"></script>
        <script type="text/javascript" src="js/modifiers/verticalmirror.js"></script>

        <script type="text/javascript" src="js/utils/canvas.js"></script>
        <script type="text/javascript" src="js/utils/color.js"></script>
        <script type="text/javascript" src="js/utils/math.js"></script>
        <script type="text/javascript" src="js/utils/string.js"></script>
        <script type="text/javascript" src="js/utils/object.js"></script>
        <script type="text/javascript" src="js/utils/stroke.js"></script>
        <script type="text/javascript" src="js/utils/ui.js"></script>
        <script type="text/javascript" src="js/utils/constraints.js"></script>
        <script type="text/javascript" src="js/utils/painter.js"></script>

        <script type="text/javascript" src="js/conf.js"></script>
        <script type="text/javascript" src="js/hotkeys.js"></script>

        <script type="text/javascript">
        $(function() {
            var strokeManager = new StrokeManager();
            var $pageNameInput = $('#pageName');
            var tabCounter = 2;

            var $tabs = $('#pages').tabs({
                    tabTemplate: '<li><span class="ui-icon ui-icon-wrench modifyPage">Tools</span><a href="#{href}">#{label}</a><span class="ui-icon ui-icon-close removePage">Remove Page</span></li>',
                    add: function(event, ui) {
                        createCanvas(ui.panel.id);
                    },
                    remove: function(event, ui) {
                        strokeManager.removeCanvas(ui.panel.id + 'Canvas');
                    },
                    select: function(event, ui) {
                        strokeManager.setActiveCanvas(ui.panel.id + 'Canvas');
                    }
            });

            $('#newPageButton').button().click(function() {
                // TODO: clean up page naming
                newTab();
                selectLastTab();
            });

            $('#about').click(function() {
                $('#aboutDialog').dialog('open');
            });

            $("#aboutDialog").dialog({
                height: 140, modal: true, autoOpen: false
            });

            // TODO: make it possible to modify name, bg color etc. as well
            $('.modifyPage').live('click', function() {
                $('#modifyPageDialog').dialog('open');
            });

            $("#modifyPageDialog").dialog({
                height: 120, modal: true, autoOpen: false
            });

            var index = null;
            $('.removePage').live('click', function() {
                index = $('li',$tabs).index($(this).parent());

                $('#deleteConfirmDialog').dialog('open');
            });

            $("#deleteConfirmDialog").dialog({
                autoOpen: false,
                resizable: false,
                height:150,
                modal: true,
                buttons: {
                    'Delete page': function() {
                        $tabs.tabs('remove', index);
                        $(this).dialog('close');
                    },
                    Cancel: function() {
                        $(this).dialog('close');
                    }
                }
            });

            // page tools
            $("#exportFormats").buttonset();
            $("#exportButton").button().click(function() {
                var selectedFormat = $('#exportFormats input:checked').val();

                strokeManager.activeCanvas.saveAs(selectedFormat);

                $('#modifyPageDialog').dialog('close');
            });

            $("#copyButton").button().click(function() {
                var oldCanvas = strokeManager.activeCanvas;
                var oldCanvasData = oldCanvas.getData();

                newTab();
                selectLastTab();

                var newCanvas = strokeManager.activeCanvas;
                newCanvas.setData(oldCanvasData);

                $('#modifyPageDialog').dialog('close');
            });

            // actual addTab function: adds new tab using the title input from the form above
            function newTab() {
                var tab_title = $pageNameInput.val() || 'Tab ' + tabCounter;
                $tabs.tabs('add', '#page' + tabCounter, tab_title);
                tabCounter++;
            }

            function selectLastTab() {
                $tabs.tabs('select', $tabs.tabs('length') - 1);
            }

            // set up splitters

            // Main vertical splitter, anchored to the browser window
            $("#MySplitter").splitter({
                type: "v",
                outline: false,
                minLeft: 0, sizeLeft: 280, maxLeft: 280,
                anchorToWindow: true,
            });
            // Second vertical splitter, nested in the right pane of the main one.
            $("#CenterAndRight").splitter({
                type: "v",
                outline: false,
                minRight: 0, sizeRight: 240, maxRight: 240,
            });

            // set up initial canvas
            createCanvas("page1");

            function createCanvas(pageName) {
                var canvasId = pageName + "Canvas";

                // XXX: figure out how to calculate offsets dynamically
                $("#" + pageName).append('<div style="overflow:auto;width:' +
                    (screen.width - 60) + 'px;height:' +
                    (window.innerHeight - 85) + 'px;">' +
                    '<canvas id="' + canvasId + '" width="' +
                    (screen.width - 70) + '" height="' +
                    (window.innerHeight - 90) +
                    '" style="cursor:crosshair"' +
                    ' class="pageCanvas"></canvas></div>'
                );

                strokeManager.addCanvas(canvasId);

                $("#" + canvasId).bind('dragstart', function(e) {
                    strokeManager.start(getMouseLocationOnCanvas(e));
                });

                $("#" + canvasId).bind('drag', function(e) {
                    strokeManager.paint(getMouseLocationOnCanvas(e));
                });

                $("#" + canvasId).bind('dragend', function(e) {
                    strokeManager.end(getMouseLocationOnCanvas(e));
                });
            }

            function getMouseLocationOnCanvas(e) {
                return new Point(e.layerX, e.layerY);
            }
        });
        </script>
    </head>
    <body>
        <div id="MySplitter">
            <div class="SplitterPane" id="brushColumn"></div>

            <div id="CenterAndRight">
                <div class="SplitterPane" id="pages">
                    <ul>
                        <li>
                            <span class="ui-icon ui-icon-wrench modifyPage">Tools</span>
                            <a href="#page1">Page</a>
                            <span class="ui-icon ui-icon-close removePage">Remove Page</span>
                        </li>
                    </ul>
                    <div id="page1"></div>
                </div>

                <div class="SplitterPane" id="canvasColumn">
                    <div id="menu" style="height:2em">
                        <div id="pods">
                            <button id="newPageButton">New Page</button>
                        </div>

                        <span class="ui-icon ui-icon-help" id="about">About</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="modifyPageDialog" title="Tools">
            <div id="export">
                <div id="exportFormats">
                    <input type="radio" id="jpgFormat" name="exportFormats" checked="checked" value="jpg" /><label for="jpgFormat">JPG</label>
                    <input type="radio" id="pngFormat" name="exportFormats" value="png" /><label for="pngFormat">PNG</label>
                    <input type="radio" id="bmpFormat" name="exportFormats" value="bmp" /><label for="bmpFormat">BMP</label>
                </div>
                <button id="exportButton">Export</button>
                <button id="copyButton">Copy</button>
            </div>
	</div>

        <div id="aboutDialog" title="About">
            <p>Harmony v. 0.3</p>
            <p>
                <a href="http://mrdoob.com/blog/post/689" target="_blank">The original system</a>
            </p>
            <p>
                <a href="http://github.com/bebraw/Harmony-Brushes" target="_blank">Source</a>
            </p>
        </div>

        <div id="deleteConfirmDialog" title="Delete page?">
            <p>
                <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
                    The page will be deleted permanently and cannot be recovered. Are you sure?
            </p>
        </div>

        <script type="text/javascript">
            var panels = {}
            for (var i = 0; i < PANELS.length; i++) {
                var panelName = PANELS[i];

                var panel = eval("new " + panelName + "()");
                panels[panelName] = panel;

                shortcut.add((i+1).toString(), function(e) {
                    var keyChar = $.charcode(e);
                    var keyNum = parseInt(keyChar) - 1;
                    var panel = PANELS[keyNum];

                    if($("#" + panel + "Pod").css('visibility') == 'visible') {
                        $("#" + panel + "Pod").click();
                    }
                    else {
                        $("#" + panel + "Panel").dialog('close');
                    }
                });
            }

            // initialize panel UI and hotkeys
            panels['brushes'].initUI('brushColumn');
            panels['palette'].initUI('brushColumn');
            panels['canvas'].initUI('canvasColumn');
            panels['modifiers'].initUI('canvasColumn'); // XXX: split up symmetry
            
            for (panelName in panels) {
                panel = panels[panelName];

                if( 'initHotkeys' in panel ) {
                    panel.initHotkeys();
                }
            }
        </script>
    </body>
</html>
