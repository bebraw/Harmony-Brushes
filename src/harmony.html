<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Licensed under the MIT license: -->
<!-- http://www.opensource.org/licenses/mit-license.php -->
<!-- Copyright (c) 2010 Mr.doob, rhyolight, bebraw -->
<html lang="en">
    <head>
        <title>Harmony</title>
        
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">

        <link rel="stylesheet" type="text/css" href="css/ui-darkness/jquery-ui-1.8.custom.css" />
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <link rel="stylesheet" type="text/css" href="css/colorpicker.css">

        <script type="text/javascript" src="js/lib/jquery.js"></script>
        <script type="text/javascript" src="js/lib/jquery-ui.js"></script>
        <script type="text/javascript" src="js/lib/jquery-keycodes.js"></script>
        <script type="text/javascript" src="js/lib/jquery-drag.js"></script>
        <script type="text/javascript" src="js/lib/shortcut.js"></script>
        <script type="text/javascript" src="js/lib/base64.js"></script>
        <script type="text/javascript" src="js/lib/canvas2image.js"></script>
        <script type="text/javascript" src="js/lib/jscolor/jscolor.js"></script>

        <script type="text/javascript" src="js/lib/canvas.text.js"></script>
        <script type="text/javascript" src="js/lib/faces/helvetiker-normal-normal.js"></script>

        <script type="text/javascript" src="js/panels/brushes.js"></script>
        <script type="text/javascript" src="js/panels/canvas.js"></script>
        <script type="text/javascript" src="js/panels/modifiers.js"></script>
        <script type="text/javascript" src="js/panels/playback.js"></script>
        <script type="text/javascript" src="js/panels/palette.js"></script>

        <script type="text/javascript" src="js/brushes/sketchy.js"></script>
        <script type="text/javascript" src="js/brushes/shaded.js"></script>
        <script type="text/javascript" src="js/brushes/chrome.js"></script>
        <script type="text/javascript" src="js/brushes/fur.js"></script>
        <script type="text/javascript" src="js/brushes/longfur.js"></script>
        <script type="text/javascript" src="js/brushes/web.js"></script>
        <script type="text/javascript" src="js/brushes/simple.js"></script>
        <script type="text/javascript" src="js/brushes/square.js"></script>
        <script type="text/javascript" src="js/brushes/ribbon.js"></script>
        <script type="text/javascript" src="js/brushes/circles.js"></script>
        <script type="text/javascript" src="js/brushes/squares.js"></script>
        <script type="text/javascript" src="js/brushes/grid.js"></script>
        <script type="text/javascript" src="js/brushes/stringy.js"></script>
        <script type="text/javascript" src="js/brushes/curvy.js"></script>
        <script type="text/javascript" src="js/brushes/eraser.js"></script>
        <script type="text/javascript" src="js/brushes/blur.js"></script>

        <script type="text/javascript" src="js/modifiers/array.js"></script>
        <script type="text/javascript" src="js/modifiers/group.js"></script>
        <script type="text/javascript" src="js/modifiers/horizontalmirror.js"></script>
        <script type="text/javascript" src="js/modifiers/radialmirror.js"></script>
        <script type="text/javascript" src="js/modifiers/verticalmirror.js"></script>

        <script type="text/javascript" src="js/projectors/cycletarget.js"></script>
        <script type="text/javascript" src="js/projectors/horizontal.js"></script>
        <script type="text/javascript" src="js/projectors/parallel.js"></script>
        <script type="text/javascript" src="js/projectors/radial.js"></script>
        <script type="text/javascript" src="js/projectors/settarget.js"></script>
        <script type="text/javascript" src="js/projectors/target.js"></script>
        <script type="text/javascript" src="js/projectors/vertical.js"></script>

        <script type="text/javascript" src="js/utils/canvas.js"></script>
        <script type="text/javascript" src="js/utils/color.js"></script>
        <script type="text/javascript" src="js/utils/math.js"></script>
        <script type="text/javascript" src="js/utils/string.js"></script>
        <script type="text/javascript" src="js/utils/object.js"></script>
        <script type="text/javascript" src="js/utils/stroke.js"></script>
        <script type="text/javascript" src="js/utils/ui.js"></script>
        <script type="text/javascript" src="js/utils/constraints.js"></script>
        <script type="text/javascript" src="js/utils/painter.js"></script>
        <script type="text/javascript" src="js/utils/projection.js"></script>

        <script type="text/javascript" src="js/conf.js"></script>
        <script type="text/javascript" src="js/hotkeys.js"></script>

        <script type="text/javascript">
        $(function() {
            mouseLocation = null; // XXX: move to a nicer place (abstract out as a Mouse class?)
            var strokeManager = new StrokeManager();
            var $pageNameInput = $('#pageName');

            $('#newPageButton').button().click(function() {
                // TODO: clean up page naming
                newTab();
                selectLastTab();
            });

            $('#about').click(function() {
                $('#aboutDialog').dialog('open');
            });

            $("#aboutDialog").dialog({
                height: 140, modal: true, autoOpen: false
            });

            // TODO: make it possible to modify name, bg color etc. as well
            $('.modifyPage').live('click', function() {
                $('#modifyPageDialog').dialog('open');
            });

            $("#modifyPageDialog").dialog({
                height: 120, modal: true, autoOpen: false
            });

            var index = null;
            $('.removePage').live('click', function() {
                index = $('li',$tabs).index($(this).parent());

                $('#deleteConfirmDialog').dialog('open');
            });

            $("#deleteConfirmDialog").dialog({
                autoOpen: false,
                resizable: false,
                height:150,
                modal: true,
                buttons: {
                    'Delete page': function() {
                        $tabs.tabs('remove', index);
                        $(this).dialog('close');
                    },
                    Cancel: function() {
                        $(this).dialog('close');
                    }
                }
            });

            // page tools
            $("#exportFormats").buttonset();
            $("#exportButton").button().click(function() {
                var selectedFormat = $('#exportFormats input:checked').val();

                strokeManager.activeCanvas.saveAs(selectedFormat);

                $('#modifyPageDialog').dialog('close');
            });

            $("#copyButton").button().click(function() {
                var oldCanvas = strokeManager.activeCanvas;
                var oldCanvasData = oldCanvas.getData();

                newTab();
                selectLastTab();

                var newCanvas = strokeManager.activeCanvas;
                newCanvas.setData(oldCanvasData);

                $('#modifyPageDialog').dialog('close');
            });

            function newTab() { // XXX
                var tab_title = $pageNameInput.val() || 'Tab ' + tabCounter;
                $tabs.tabs('add', '#page' + tabCounter, tab_title);
                tabCounter++;
            }

            function selectLastTab() { // XXX
                $tabs.tabs('select', $tabs.tabs('length') - 1);
            }

            // set up initial canvas and overlay
            createCanvas("page1");

            function createCanvas(pageName) {
                var canvasId = pageName + "Canvas";
                var canvasWidth = screen.width;
                var canvasHeight = window.innerHeight;

                $("#main").append('<canvas id="' + canvasId + '" width="' +
                    canvasWidth + '" height="' +
                    canvasHeight + '" style="z-index:0;position:absolute;top:0px;left:0px;"' +
                    ' class="pageCanvas"></canvas>' +
                    '<canvas id="overlayCanvas" width="' + canvasWidth + '"' +
                    ' height="' + canvasHeight +
                    '" style="cursor:crosshair;z-index:100;position:absolute;top:0px;left:0px;"></canvas>'
                 );

                strokeManager.addCanvas(canvasId);

                $("#overlayCanvas").bind('dragstart', function(e) {
                    strokeManager.start(mouseLocation);
                }).bind('drag', function(e) {
                    strokeManager.paint(mouseLocation);
                }).bind('dragend', function(e) {
                    strokeManager.end(mouseLocation);
                }).bind('mousemove', function(e) {
                    mouseLocation = getMouseLocationOnCanvas(e);
                });
            }

            function getMouseLocationOnCanvas(e) {
                return new Point(e.layerX, e.layerY);
            }
        });
        </script>
    </head>
    <body>
        <div id="main"></div>

        <div id="brushColumn" style="position:absolute;left:0px;top:50px;background-color:black"></div>

        <div id="canvasColumn" style="position:absolute;right:0px;top:50px;background-color:black">
            <div id="menu" style="height:2em">
                <div id="pods">
                    <button id="newPageButton">New Page</button>
                </div>

                <span class="ui-icon ui-icon-help" id="about">About</span>
            </div>
        </div>

        <div id="modifyPageDialog" title="Tools">
            <div id="export">
                <div id="exportFormats">
                    <input type="radio" id="jpgFormat" name="exportFormats" checked="checked" value="jpg" /><label for="jpgFormat">JPG</label>
                    <input type="radio" id="pngFormat" name="exportFormats" value="png" /><label for="pngFormat">PNG</label>
                    <input type="radio" id="bmpFormat" name="exportFormats" value="bmp" /><label for="bmpFormat">BMP</label>
                </div>
                <button id="exportButton">Export</button>
                <button id="copyButton">Copy</button>
            </div>
	</div>

        <div id="aboutDialog" title="About">
            <p>Harmony v. 0.3</p>
            <p>
                <a href="http://mrdoob.com/blog/post/689" target="_blank">The original system</a>
            </p>
            <p>
                <a href="http://github.com/bebraw/Harmony-Brushes" target="_blank">Source</a>
            </p>
        </div>

        <div id="deleteConfirmDialog" title="Delete page?">
            <p>
                <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
                    The page will be deleted permanently and cannot be recovered. Are you sure?
            </p>
        </div>

        <script type="text/javascript">
            var panels = {}
            for (var i = 0; i < PANELS.length; i++) {
                var panelName = PANELS[i];

                var panel = eval("new " + panelName + "()");
                panels[panelName] = panel;

                shortcut.add((i+1).toString(), function(e) {
                    var keyChar = $.charcode(e);
                    var keyNum = parseInt(keyChar) - 1;
                    var panel = PANELS[keyNum];

                    if($("#" + panel + "Pod").css('visibility') == 'visible') {
                        $("#" + panel + "Pod").click();
                    }
                    else {
                        $("#" + panel + "Panel").dialog('close');
                    }
                });
            }

            // initialize panel UI and hotkeys
            panels['brushes'].initUI('brushColumn');
            panels['palette'].initUI('brushColumn');
            panels['canvas'].initUI('canvasColumn');
            panels['modifiers'].initUI('canvasColumn'); // XXX: split up symmetry
            
            for (panelName in panels) {
                panel = panels[panelName];

                if( 'initHotkeys' in panel ) {
                    panel.initHotkeys();
                }
            }

            // CSS hacks
            $('#brushColumn').children().css('background-color', 'black');
            $('#brushColumn').find('*').css('z-index', '100');
            $('#canvasColumn').find('*').css('z-index', '100');
        </script>
    </body>
</html>
