<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Licensed under the MIT license: -->
<!-- http://www.opensource.org/licenses/mit-license.php -->
<!-- Copyright (c) 2010 Mr.doob, rhyolight, bebraw -->
<html lang="en">
    <head>
        <title>Harmony</title>
        
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">

        <link rel="stylesheet" type="text/css" href="css/ui-darkness/jquery-ui-1.8.custom.css" />
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <link rel="stylesheet" type="text/css" href="css/colorpicker.css">

        <script type="text/javascript" src="js/lib/jquery.js"></script>
        <script type="text/javascript" src="js/lib/jquery-ui.js"></script>
        <script type="text/javascript" src="js/lib/jquery-keycodes.js"></script>
        <script type="text/javascript" src="js/lib/jquery-drag.js"></script>
        <script type="text/javascript" src="js/lib/shortcut.js"></script>
        <script type="text/javascript" src="js/lib/base64.js"></script>
        <script type="text/javascript" src="js/lib/canvas2image.js"></script>
        <script type="text/javascript" src="js/lib/jscolor/jscolor.js"></script>

        <script type="text/javascript" src="js/panels/brushes.js"></script>
        <script type="text/javascript" src="js/panels/canvas.js"></script>
        <script type="text/javascript" src="js/panels/menu.js"></script>
        <script type="text/javascript" src="js/panels/modifiers.js"></script>
        <script type="text/javascript" src="js/panels/playback.js"></script>

        <script type="text/javascript" src="js/brushes/sketchy.js"></script>
        <script type="text/javascript" src="js/brushes/shaded.js"></script>
        <script type="text/javascript" src="js/brushes/chrome.js"></script>
        <script type="text/javascript" src="js/brushes/fur.js"></script>
        <script type="text/javascript" src="js/brushes/longfur.js"></script>
        <script type="text/javascript" src="js/brushes/web.js"></script>
        <script type="text/javascript" src="js/brushes/simple.js"></script>
        <script type="text/javascript" src="js/brushes/square.js"></script>
        <script type="text/javascript" src="js/brushes/ribbon.js"></script>
        <script type="text/javascript" src="js/brushes/circles.js"></script>
        <script type="text/javascript" src="js/brushes/squares.js"></script>
        <script type="text/javascript" src="js/brushes/grid.js"></script>
        <script type="text/javascript" src="js/brushes/stringy.js"></script>
        <script type="text/javascript" src="js/brushes/curvy.js"></script>
        <script type="text/javascript" src="js/brushes/eraser.js"></script>
        <script type="text/javascript" src="js/brushes/blur.js"></script>

        <script type="text/javascript" src="js/constraints/horizontal.js"></script>
        <script type="text/javascript" src="js/constraints/perspective.js"></script>
        <script type="text/javascript" src="js/constraints/vertical.js"></script>

        <script type="text/javascript" src="js/modifiers/array.js"></script>
        <script type="text/javascript" src="js/modifiers/group.js"></script>
        <script type="text/javascript" src="js/modifiers/horizontalmirror.js"></script>
        <script type="text/javascript" src="js/modifiers/radialmirror.js"></script>
        <script type="text/javascript" src="js/modifiers/verticalmirror.js"></script>

        <script type="text/javascript" src="js/utils/canvas.js"></script>
        <script type="text/javascript" src="js/utils/color.js"></script>
        <script type="text/javascript" src="js/utils/math.js"></script>
        <script type="text/javascript" src="js/utils/string.js"></script>
        <script type="text/javascript" src="js/utils/object.js"></script>
        <script type="text/javascript" src="js/utils/stroke.js"></script>
        <script type="text/javascript" src="js/utils/ui.js"></script>
        <script type="text/javascript" src="js/utils/constraints.js"></script>
        <script type="text/javascript" src="js/utils/painter.js"></script>

        <script type="text/javascript" src="js/conf.js"></script>
        <script type="text/javascript" src="js/hotkeys.js"></script>

        <script type="text/javascript">
        $(function() {
            var strokeManager = new StrokeManager();
            var $pageNameInput = $('#pageName');
            var tabCounter = 2;

            var $tabs = $('#pages').tabs({
                    tabTemplate: '<li><span class="ui-icon ui-icon-wrench modifyPage">Tools</span><a href="#{href}">#{label}</a><span class="ui-icon ui-icon-close removePage">Remove Page</span></li>',
                    add: function(event, ui) {
                        if($("#copyPage").attr('checked')) {
                            var oldCanvas = strokeManager.activeCanvas;
                            var oldCanvasData = oldCanvas.getData();

                            createCanvas(ui.panel.id);

                            var newCanvas = strokeManager.activeCanvas;
                            newCanvas.setData(oldCanvasData);
                        }
                        else {
                            createCanvas(ui.panel.id);
                        }
                    },
                    remove: function(event, ui) {
                        strokeManager.removeCanvas(ui.panel.id + 'Canvas');
                    },
                    select: function(event, ui) {
                        strokeManager.setActiveCanvas(ui.panel.id + 'Canvas');
                    }
            });

            // modal dialog init: custom buttons and a "close" callback reseting the form inside
            var $newPageDialog = $('#newPageDialog').dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    'New': function() {
                        newTab();
                        $tabs.tabs('select', $tabs.tabs('length') - 1);
                        $(this).dialog('close');
                    },
                    'Cancel': function() {
                        $(this).dialog('close');
                    }
                },
                open: function() {
                        $pageNameInput.focus();
                },
                close: function() {
                        $form[0].reset();
                }
            });
            $("#copyPage").button();

            // addTab form: calls addTab function on submit and closes the dialog
            var $form = $('form', $newPageDialog).submit(function() {
                    newTab();
                    $newPageDialog.dialog('close');
                    return false;
            });

            // actual addTab function: adds new tab using the title input from the form above
            function newTab() {
                    var tab_title = $pageNameInput.val() || 'Tab ' + tabCounter;
                    $tabs.tabs('add', '#page' + tabCounter, tab_title);
                    tabCounter++;
            }

            $('#addNew').click(function() {
                $newPageDialog.dialog('open');
            });

            $('#about').click(function() {
                $('#aboutDialog').dialog('open');
            });

            $("#aboutDialog").dialog({
                height: 140, modal: true, autoOpen: false
            });

            // TODO: make it possible to modify name, bg color etc. as well
            $('.modifyPage').live('click', function() {
                $('#modifyPageDialog').dialog('open');
            });

            $("#modifyPageDialog").dialog({
                height: 120, modal: true, autoOpen: false
            });

            var index = null;
            $('.removePage').live('click', function() {
                index = $('li',$tabs).index($(this).parent());

                $('#deleteConfirmDialog').dialog('open');
            });

            $("#deleteConfirmDialog").dialog({
                autoOpen: false,
                resizable: false,
                height:150,
                modal: true,
                buttons: {
                    'Delete page': function() {
                        $tabs.tabs('remove', index);
                        $(this).dialog('close');
                    },
                    Cancel: function() {
                        $(this).dialog('close');
                    }
                }
            });

            // export logic
            $('#exportImage').click(function() {
                $('#exportDialog').dialog('open');
            });

            $("#exportFormats").buttonset();
            $("#exportButton").button();

            $('#exportButton').click(function() {
                var selectedFormat = $('#exportFormats input:checked').val();

                strokeManager.activeCanvas.saveAs(selectedFormat);

                $('#exportDialog').dialog('close');
            });

            createCanvas("page1");

            function createCanvas(pageName) {
                var canvasId = pageName + "Canvas";

                $("#" + pageName).append('<div style="overflow:auto;width:' +
                    (window.innerWidth - 40) + 'px;height:' +
                    (window.innerHeight - 110) + 'px;">' +
                    '<canvas id="' + canvasId + '" width="' +
                    (window.innerWidth - 40) + '" height="' +
                    (window.innerHeight - 115) +
                    '" style="cursor:crosshair"' +
                    ' class="pageCanvas"></canvas></div>'
                );

                strokeManager.addCanvas(canvasId);

                $("#" + canvasId).bind('dragstart', function(e) {
                    strokeManager.start(getMouseLocationOnCanvas(e));
                });

                $("#" + canvasId).bind('drag', function(e) {
                    strokeManager.paint(getMouseLocationOnCanvas(e));
                });

                $("#" + canvasId).bind('dragend', function(e) {
                    strokeManager.end(getMouseLocationOnCanvas(e));
                });
            }

            function getMouseLocationOnCanvas(e) {
                return new Point(e.layerX, e.layerY);
            }
        });
        </script>
    </head>
    <body>
        <div id="header" style="height:2em">
            <div id="pods">
                <span class="ui-icon ui-icon-plusthick" id="addNew">New</span>
            </div>

            <span class="ui-icon ui-icon-help" id="about">About</span>

            <ul id="colors"></ul>
        </div>
        
        <div id="pages">
            <ul>
                <li>
                    <span class="ui-icon ui-icon-wrench modifyPage">Tools</span>
                    <a href="#page1">Page</a>
                    <span class="ui-icon ui-icon-close removePage">Remove Page</span>
                </li>
            </ul>
            <div id="page1"></div>
        </div>

        <div id="newPageDialog" title="New Page">
            <form>
                <fieldset class="ui-helper-reset">
                    <label for="pageName">Name</label>
                    <input type="text" name="pageName" id="pageName" value="" class="ui-widget-content ui-corner-all" />
                    <input type="checkbox" id="copyPage" value="copy" /><label for="copyPage">Copy</label>
                </fieldset>
            </form>
	</div>

        <div id="modifyPageDialog" title="Tools">
            <div id="export">
                <div id="exportFormats">
                    <input type="radio" id="jpgFormat" name="exportFormats" checked="checked" value="jpg" /><label for="jpgFormat">JPG</label>
                    <input type="radio" id="pngFormat" name="exportFormats" value="png" /><label for="pngFormat">PNG</label>
                    <input type="radio" id="bmpFormat" name="exportFormats" value="bmp" /><label for="bmpFormat">BMP</label>
                </div>
                <button id="exportButton">Export</button>
            </div>
	</div>

        <div id="aboutDialog" title="About">
            <p>Harmony v. 0.3</p>
            <p>
                <a href="http://mrdoob.com/blog/post/689" target="_blank">The original system</a>
            </p>
            <p>
                <a href="http://github.com/bebraw/Harmony-Brushes" target="_blank">Source</a>
            </p>
        </div>

        <div id="deleteConfirmDialog" title="Delete page?">
            <p>
                <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
                    The page will be deleted permanently and cannot be recovered. Are you sure?
            </p>
        </div>

        <embed id="wacomPlugin" type="application/x-wacom-tablet" />

        <script type="text/javascript">
            var constraints = new Constraints(); // XXX: needed?
            
            var leftBoundColor = "000000";
            var rightBoundColor = "ffffff";
            $('#colors').append('<li> \
                    <input style="width: 1em; height: 1em;" class="color {valueElement:' +
                    "'leftBoundColor'" + '}" /> \
                    <input type="hidden" class="boundColor" id="leftBoundColor" value="' +
                    leftBoundColor + '" /> \
                </li>');
            
            for( var i = 0; i < AMOUNTOFCOLORS; i++ ) {
                $('#colors').append('<li> \
                        <input style="width: 1em; height: 1em;" class="clickableColor" /> \
                    </li>');
            }

            interpolateColors(leftBoundColor, rightBoundColor, AMOUNTOFCOLORS);

            // right bound
            $('#colors').append('<li> \
                    <input style="width: 1em; height: 1em;" class="color {valueElement:' +
                    "'rightBoundColor'" + '}" /> \
                    <input type="hidden" class="boundColor" id="rightBoundColor" value="' +
                    rightBoundColor + '" /> \
                </li>');

            $('.boundColor').change(function(e) {
                var hexColor = $(this).val();

                COLOR = hexToRGB(hexColor);
                panels['brushes'].renderBrushPreviews();

                leftBoundColor = $('#leftBoundColor').val();
                rightBoundColor = $('#rightBoundColor').val();

                interpolateColors(leftBoundColor, rightBoundColor,
                    AMOUNTOFCOLORS);
            });

            function interpolateColors(leftBoundColor, rightBoundColor, amountOfColors) {
                $('.clickableColor').each(function(k, v) {
                    var fac = (k + 1) / (amountOfColors + 2);
                    var color = '#' + colorLerp(leftBoundColor, rightBoundColor, fac);

                    $(this).css('background-color', color);
                });
            }

            $('.clickableColor').focus(function(e) {
                var color = $(this).css('background-color');
                var hexColor = colorToHex(color);

                COLOR = hexToRGB(hexColor);
                panels['brushes'].renderBrushPreviews();

                $('.clickableColor').removeClass('activeColor');
                $(this).addClass('activeColor');
            });

            $('.clickableColor:first').addClass('activeColor');

            function getColor() {
                return COLOR;
            }

            var panels = {}
            for (var i = 0; i < PANELS.length; i++) {
                var panelName = PANELS[i];

                var panel = eval("new " + panelName + "()");
                panels[panelName] = panel;

                shortcut.add((i+1).toString(), function(e) {
                    var keyChar = $.charcode(e);
                    var keyNum = parseInt(keyChar) - 1;
                    var panel = PANELS[keyNum];

                    if($("#" + panel + "Pod").css('visibility') == 'visible') {
                        $("#" + panel + "Pod").click();
                    }
                    else {
                        $("#" + panel + "Panel").dialog('close');
                    }
                });
            }

            // shortcuts for changing color
            shortcut.add(PREV_COLOR, function(e) {
                var prev = $(".activeColor").parent().prev().children(':first');
                prev.length && prev.focus();
            });

            shortcut.add(NEXT_COLOR, function(e) {
                var next = $(".activeColor").parent().next().children(':first');
                next.length && next.focus();
            });

            // initialize panel UI and hotkeys
            for (panelName in panels) {
                panel = panels[panelName];
                panel.initUI();

                if( 'initHotkeys' in panel ) {
                    panel.initHotkeys();
                }
            }
        </script>
    </body>
</html>
